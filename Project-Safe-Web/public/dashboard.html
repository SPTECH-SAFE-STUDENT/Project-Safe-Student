<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/dashboard.css">
    <title>Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="http://www.chartjs.org/dist/2.7.1/Chart.js"></script>
    <!-- <script src="http://www.chartjs.org/samples/latest/utils.js"></script> -->
    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            width: 150;
            height: 100;
        }

        .div-graficos {
            width: 150px;
            height: 80px;
        }
    </style>
</head>

<body>
    <div class="content">
        <div class="menuLateral">
            <img src="./img/logo_SS.png">
            <div>
                <h1>Bem vindo<br>de volta!</h1>
            </div>
            <div id="opcoes_menu" class="opcao">
                <ul>
                    <li><a onclick="telaDash()" id="OpcDashboard">Dashboard</a></li>
                    <li><a onclick="telaHistorico()" id="OpcHistorico">Histórico</a></li>
                </ul>
            </div>
        </div>

        <!-- DASHBOARD DA PLACA UM -->
        <div id="dashFCB1B34" class="visao_dash">
            <div class="kpis">
                <div id="div1">
                    <p>Bancos Ocupados</p>
                    <span>12</span>
                </div>
                <div id="div2">
                    <p>Temperatura Mínima do dia</p>
                    <span>18°C</span>
                </div>
                <div id="div3">
                    <p>Temperatura Máxima do dia</p>
                    <span>30°C</span>
                </div>
                <div id="div4">
                    <button id="botaoFinalizar" onclick="voltar()">Finalizar <br> sistema</button>
                </div>
            </div>

            <div class="graficos">

                <div class="canvas">
                    <div class="container-chave">
                        <h2>Bancos Ocupados</h2>
                        <div class="graficos-alinhamento" id="graficos_bancos">


                        </div>
                    </div>
                    <div class="container-temp">
                        <h2>Temperatura</h2>
                        <section>
                            <canvas id="lm35Temperatura"></canvas>
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
</body>

</html>

<script>

    function telaDash() {
        let cargo = sessionStorage.CARGO_USUARIO
        if (cargo == 'suporte' || cargo == 'dono') {
            window.location = "./dash.html"
        } else {
            window.location = "./dashboard.html"
        }
    }


    function voltar() {
        sessionStorage.clear()
        window.location = './index.html'
    }

    function buscarTemperatura() {

        const idVan = sessionStorage.PLACA_VAN;

        if (!idVan) {
            console.error('Van do usuário não está definida');
            return;
        }

        fetch(`/dashboard/buscarTemperatura/${idVan}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            }
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    return resposta.json();
                } else {
                    throw new Error("Houve um erro ao tentar trazer o resultado");
                }
            })
            .then(function (data) {
                // console.log(data)

                const temperaturasA = [];

                const temperaturasB = [];

                const Horario = [];

                // console.log("Temperaturas:")
                data.forEach(element => {


                    let SensorA = element.SensorTempA

                    let SensorB = element.SensorTempB

                    // console.log(element.horario)
                    Horario.push(element.horario);

                    if (SensorA != null) {
                        temperaturasA.push(element.SensorTempA)

                    } else if (SensorB != null) {

                        temperaturasB.push(element.SensorTempB)
                    }



                });

                if (data.length === 0) {
                    console.warn("Nenhum resultado encontrado");
                    return;
                }
                // console.log(temperaturasA)
                // console.log(temperaturasB)
                atualizarGrafico(temperaturasA, temperaturasB, Horario);
            })
            .catch(function (erro) {
                console.error(`#ERRO: ${erro}`);
            });
    }


    function atualizarGrafico(temperaturasA, temperaturasB, Horario) {
        const ctx = document.getElementById('lm35Temperatura').getContext('2d');
        // console.log(temperaturasA, temperaturasB)
        // console.log("TEMPERATURAS:")

        // temperaturasA.forEach(element => {

        //     // console.log(element.temperatura)

        // });
        // temperaturasB.forEach(element => {

        //     // console.log(element.temperatura)

        // });

        // if (graficoTemperatura) {
        //     graficoTemperatura.destroy();
        // }
        let HorarioSlice = Horario.slice(0, 10)
        // let temperaturasASlice = temperaturasA.slice(0,10)
        // let temperaturasBSlice = temperaturasB.slice(0,10)
        // Extrai as quantidades do objeto de resultados


        graficoTemperatura = new Chart(ctx, {
            type: 'line',
            data: {
                labels: HorarioSlice,
                datasets: [{
                    label: 'Sensor 1',
                    borderColor: '#FFF348',
                    backgroundColor: '#FFF348',
                    fill: false,
                    data: temperaturasA
                },
                {
                    label: 'Sensor 2',
                    borderColor: '#123456',
                    backgroundColor: '#123456',
                    fill: false,
                    data: temperaturasB
                }]
            },
            options: {
                animation: false,
                scales: {
                    xAxes: [{
                        display: true,
                        ticks: {
                            reverse: true, // Inverte o eixo X
                            // beginAtZero: false,
                        },
                    }],
                    yAxes: [{
                        ticks: {
                            min: 5, // Define o valor mínimo do eixo Y
                                 // Define o valor máximo do eixo Y
                            // beginAtZero: true
                        },
                        display: true
                    }]
                },
                animation: {
                    duration: 0
                },
            }
        });
    }

    buscarTemperatura()
    setInterval(buscarTemperatura, 5000);

    obterDAta()
    setTimeout(obterDAta, 110);

    obterDAta()
    setInterval(obterDAta, 2000);


    const chave = {};



    function atualizarGraficoChave(data) {

        // console.log(data)
        data.forEach(element => {
            // console.log(element)
            let sensorIndex = element.fksensorProx; // Supondo que fksensorProx é o índice do gráfico
            if (chave[`chart${sensorIndex}`]) {
                chave[`chart${sensorIndex}`].data.datasets[0].data = [element.chave];
                chave[`chart${sensorIndex}`].update();
            }
        });
    }

    const BancosGerar = [];

    function obterDAta() {
        const idVan = sessionStorage.PLACA_VAN;


        // Fetch para obter os dados
        fetch(`/dashboard/buscarProximidade/${idVan}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            }
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    return resposta.json();
                } else {
                    throw new Error("Houve um erro ao tentar trazer o resultado");
                }
            })
            .then(function (data) {
                // console.log(data);
                if (data.length === 0) {
                    console.warn("Nenhum resultado encontrado");
                    return;
                }
                data.forEach(element =>{
                    BancosGerar.push(element.fksensorProx)

                });

                atualizarGraficoChave(data);
            })
            .catch(function (erro) {
                console.error(`#ERRO: ${erro}`);
            });
    }

    setTimeout(() => {
        plotarGraficos()  
    }, 100);

    function plotarGraficos() {

        const bancos = sessionStorage.QTDBANCOS_VAN

        const container = document.getElementById('graficos_bancos');


        let numero = 0
        for (let i = BancosGerar[0]; i <= BancosGerar[BancosGerar.length-1]; i++) {
            numero++
            let div = document.createElement('div');
            div.className = 'div-graficos';
            let canvas = document.createElement('canvas');
            canvas.id = `chart${i}`;
            canvas.className = 'chart-container';
            canvas.style.width = "100px";
            canvas.style.height = "80px";
            container.appendChild(div);
            div.appendChild(canvas);

            let ctx = canvas.getContext('2d');

            chave[`chart${i}`] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [`${i}`],
                    datasets: [{
                        label: `Banco ${numero}`,
                        data: [0], // Inicialmente vazio
                        borderColor: '#FFB800',
                        backgroundColor: '#FFB800'
                    }]
                },
                options: {
                    scales: {
                        xAxes: [{
                            distribution: 'series',
                            display: false,
                            ticks: {
                                beginAtZero: true
                            }
                        }],
                        yAxes: [{
                            distribution: 'series',
                            display: true,
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    },
                    animation: {
                        duration: 0
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#000000'
                            }
                        }
                    }
                }
            });
        }
    }

</script>