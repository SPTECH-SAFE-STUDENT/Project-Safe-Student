<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="./css/dash.css" />

  <style>
    
    
  </style>
</head>

<body onload="exibirVans()">
  <div class="content">
    <div class="menuLateral">
      <img src="./img/logo_SS.png" />
      <div>
        <h1>Bem vindo<br />de volta!</h1>
      </div>
      <div class="opcao">
        <ul>
          <li>Principal</li>
          <li>Perfil</li>
          <li onclick="limparSessao()">Sair</a></li><br><br>
          <li onclick="openModal()">Suporte</li>
        </ul>
      </div>
    </div>
    <div class="kpis">
      <div id="1">
        <p>Vans em serviço</p>
        <span>10/18</span>
      </div>
      <div id="2">
        <p>Vans em estado crítico</p>
        <span>1</span>
      </div>
      <div id="3">
        <p>Alertas do dia</p>
        <span>8</span>
      </div>
      <div id="legenda">
        <div class="media">
          <h1 class="text_legenda">Alerta</h1>
        </div>
        <div class="critico">
          <h1 class="text_legenda">Crítico</h1>
        </div>
      </div>
    </div>
    <div class="lista_metrica">
      <div class="status_geral" id="div_vans">
        <h2>Status geral: <span> A situação esta <red style="color: red;">crítica</red> no momento<span></h2>
        <div class="lista" style="display: flex;">
          <div class="van">

            <img src="./img/vanCritica.png" alt="">
            <div style="display: flex;">

              <span>Placa: ACD54Y</span>
              <span>Temperatura 27°C</span>
              <span>Status: Em serviço</span>
            </div>

            <a href="dashboard2.html">IR</a>
          </div>
        </div>
      </div>
      <div class="metricas">
        <div class="campoPesquisa">
          <span><img src="./img/lupa.png" alt=""><b>Pesquise por uma van</b><br>
          <input type="search" placeholder="Digite a placa">
          <button>Buscar</button>
        </div>
        <div class="servico">
          <span><b>Vans em serviço: </b><br>
            Vans que estão trabalhando no momento
          </span>
        </div>
        <div class="estado">
          <span><b>Estado crítico: </b><br>
            Vans com alertas contantes ou erros graves no sistema
          </span>
        </div>
        <div class="alerta">
          <span><b>Alertas do dia: </b><br>
            Quantidade de alertas no dia atual
          </span>
        </div>
      </div>
    </div>
  </div>

  <dialog id="modal">
    <div class="modal-content">
      <button id="closeModalBtn" onclick="closeModal()" class="close">x</button>
      <div id="divcenter">

        <h2>Acesse o Portal</h2>
        <button id="acess-btn" onclick="sendToJira()">Portal Suporte</button>
        <br><br><br><br><br>
        <div id="suporte_modal" style="display: none;">
          <h2>SafeIA para Suporte</h2>
          <button id="acess-btn" onclick="openSafeIA()">SafeIA</button>
        </div>

        <div id="container-safeIA" class="modal-safeIA">
          <center>
            <h1 style="margin-right: -46vh; color: #FFB800;">SafeIA</h1>
            <textarea id="pergunta" type="text" placeholder="Digite a pergunta..." style=" width: 288px;
            margin-right: -43.5vh;
            height: 65px;"></textarea>
            <br><br>
            <button id="button2" onclick="gerarResposta()">Gerar Resposta</button>
          </center>
        </div>
      </div>
      <div class="bordaDiv">
      <div id="resposta"></div>
    </div></div>
  </dialog>

  <script>
    var modal = document.getElementById("modal");
    var closeBtn = document.getElementById("closeModalBtn");

    function openModal() {
      let usuarioNaSessao = sessionStorage.NOME_USUARIO;
      modal.showModal();
      if (usuarioNaSessao == "Suporte") {
        document.getElementById("suporte_modal").style.display = "block";
      }
    }

    function closeModal() {
      modal.close();
    }

    function openSafeIA() {
      document.getElementById("divcenter").innerHTML = `
        <h2>SafeIA</h2>
      `;
    }

    function limparSessao(){
      sessionStorage.clear();
      window.location = "index.html" 
    }

    async function gerarResposta() {
      const pergunta = document.getElementById('pergunta').value;

      const response = await fetch('http://localhost:3334/perguntar', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ pergunta })
      });

      const data = await response.json();

      document.getElementById('resposta').style.display = 'block';
      document.getElementById('resposta').innerText = data.resultado;
    }

    function exibirVans() {
      var Cor = 'Normal'
      var aparecerCard = 'block'
      JSON.parse(sessionStorage.VANS_EM_ALERTA).forEach(item => {
        var temperatura = Number(item.ultima_temperatura)
        console.log(item)
        console.log(temperatura)
        
        if( temperatura >= 28){
          Cor = 'Critica'
        }else if(temperatura >=25){
          Cor = 'Alerta'
        }else{
          aparecerCard = 'none'
        }
        
        document.getElementById("div_vans").innerHTML += `
          <div class="lista" style="display: ${aparecerCard};">
            <div class="van">
              <img src="./img/van${Cor}.png" alt="">
              <div style="display: flex; gap: 20px;">
                <span>Placa:<br>${item.placa}</span>
                <span id="temp_van_${item.placa}">Temperatura ${item.ultima_temperatura}°C</span>
                <span id="card_${item.placa}">Status: Em serviço</span>
              </div>
              <a href="dashboard2.html">IR</a>
            </div>
          </div>
        `;

      });
    }
  </script>
</body>

</html>